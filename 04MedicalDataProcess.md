進階醫學資料處理分析
========================================================
author: 長庚資管 曾意儒 Yi-Ju Tseng
autosize: true
font-family: 'Microsoft JhengHei'
navigation: slide

大綱
========================================================
type:sub-section 
- 使用套件清單
- 研究案例篩選
- 醫學資料處理
  - 診斷碼處理
  - 藥物資料處理
  - 多重測量資料整合

使用套件清單
========================================================
- dplyr [官網](https://dplyr.tidyverse.org/)
- icd [教學](https://cran.r-project.org/web/packages/icd/vignettes/introduction.html)
- AdhereR [官網](https://github.com/ddediu/AdhereR)
- emr [官網](https://github.com/DHLab-CGU/emr)


研究案例篩選
========================================================
type:sub-section 
- 基於特定病人清單
- 基於醫療紀錄
  - 特定診斷碼
  - 在特定時間出現
  - 出現特定次數
- 應保留的重要資料
- 使用針對**資料列Row**做**子集**的概念，可參考[資料科學與R語言](https://yijutseng.github.io/DataScienceRBook/eda.html#filter)

研究案例篩選 - 基於特定病人清單
========================================================

先載入範例資料

```r
library(readr)
DiagSum <- read_csv("DiagSumS.csv")
knitr::kable(DiagSum[1:10,1:5])
```



|院區 | 資料年月|歸戶代號                                 | 輸入日期|住院號                                   |
|:----|--------:|:----------------------------------------|--------:|:----------------------------------------|
|8    |   201604|BAAA072314782F830F02210D13A3A549827A3D67 | 20160421|702C16076DD204640C6A5FC7F59B79F197DDB256 |
|3    |   201604|5D3719C5F07EF19DC4BCAF4CDF3307C2A397337D | 20160418|7E18FC6A8CA3C9CD01FF31AFD23DE0765FCEF7E1 |
|8    |   201604|05A02952E9CB8FF7BBAC1A135ED2A7C7E065B285 | 20160425|9E75B54E1E88CF63E99E543B2EDF48F8478CEC5E |
|2    |   201604|83949E36D0009A4BE9ED122D8219ABF399C66AB2 | 20160416|34B3E2C9602960838D69D8C0215B6F0E46B9E09C |
|3    |   201604|674BBCF56F8B25AF0E78AC5E308039459ECF055B | 20160502|F051C0914711A31F552D53BE3A8FF7F6A4CA6C0B |
|E    |   201606|9583AC8115FA1F428400A10269D7C5EA1258EE0F | 20160623|BBEEBD6E5373AABA417B1973588E50A4BB418916 |
|3    |   201606|026322633E1C2D8D6999445B587AEC7ABF4FBE25 | 20160627|4E78B439FAC4F490A383E738AF0964E512C3EFAD |
|8    |   201606|ECD64C74AAA107ADBD55EA002D054F2FDE2C8B6E | 20160613|11817F33763B2D11EA2F582792881F6F44F104B3 |
|1    |   201606|BA115A73BD30BCDB95493964FB36619325C79810 | 20160616|9F10798D5C4F7FDEADC6A87E43A4E9E2F9CE67E1 |
|3    |   201606|3435DAE792B502572E9C86BB2D431DC2224C3C2D | 20160618|54837CCD1F237967F0FA52F7FD3D9173EFE57366 |

研究案例篩選 - 基於特定病人清單
========================================================

提供歸戶代號清單(向量)，並使用**%in%**篩選符合此條件之所有資料

```r
library(dplyr)
SelectedCase<-DiagSum %>% 
  filter(歸戶代號 %in% c("05A02952E9CB8FF7BBAC1A135ED2A7C7E065B285",
                     "83949E36D0009A4BE9ED122D8219ABF399C66AB2"))
knitr::kable(SelectedCase [1:10,c(1,3,12,26)])
```



|院區 |歸戶代號                                 | 住院日期|診斷類別1 |
|:----|:----------------------------------------|--------:|:---------|
|8    |05A02952E9CB8FF7BBAC1A135ED2A7C7E065B285 | 20160226|C7932     |
|2    |83949E36D0009A4BE9ED122D8219ABF399C66AB2 | 20160412|C50911    |
|8    |05A02952E9CB8FF7BBAC1A135ED2A7C7E065B285 | 20160531|C50811    |
|2    |83949E36D0009A4BE9ED122D8219ABF399C66AB2 | 20160614|C50911    |
|2    |83949E36D0009A4BE9ED122D8219ABF399C66AB2 | 20160705|C50911    |
|2    |83949E36D0009A4BE9ED122D8219ABF399C66AB2 | 20160726|C50911    |
|2    |83949E36D0009A4BE9ED122D8219ABF399C66AB2 | 20160524|C50911    |
|8    |05A02952E9CB8FF7BBAC1A135ED2A7C7E065B285 | 20100629|1748      |
|8    |05A02952E9CB8FF7BBAC1A135ED2A7C7E065B285 | 20100528|1748      |
|2    |83949E36D0009A4BE9ED122D8219ABF399C66AB2 | 20160503|C50911    |


研究案例篩選 - 基於特定病人清單
========================================================
type:alert

- 使用疾病分類統計檔DiagSum與基本資料檔

```r
library(readr)
DiagSum <- read_csv("DiagSumS.csv")
BasicS <- read_csv("BasicS.csv")
knitr::kable(BasicS[1:3,])
```



|院區 |歸戶代號                                 |性別 |     生日|
|:----|:----------------------------------------|:----|--------:|
|1    |DB26EFB5F66F696208693AA3D402D03B2B8D1CB5 |F    | 19581201|
|5    |80DB2AFAAEADC0874A35C71DB8CC693B6B33D7BF |F    | 19680725|
|E    |0E48E47A75EC741DFF678BFDCB36D394546E6A82 |F    | 19540914|
- 篩選條件：只留下**歸戶代號**，出現在基本資料檔案中的紀錄
- 符合條件的患者共有幾人？
- 子集 or inner_join()

研究案例篩選 - 基於醫療紀錄
========================================================

提供診斷碼清單(向量)，並使用**%in%**或**grepl()**篩選符合此條件之所有資料


```r
library(dplyr)
# 174.0 Malignant neoplasm of nipple and areola of female breast
# 174.1 Malignant neoplasm of central portion of female breast
SelectedCase<-DiagSum %>% 
  filter(診斷類別1 %in% c("1740","1741"))
knitr::kable(SelectedCase [1:10,c(1,3,12,26)])
```



|院區 |歸戶代號                                 | 住院日期|診斷類別1 |
|:----|:----------------------------------------|--------:|:---------|
|N    |CB97DD083522D6D3F62D67146288DDEADAAC6C96 | 20060618|1741      |
|3    |142FBA9E34A712DEA6E6C086DDBA6B47A48030BA | 20070816|1741      |
|1    |903C5D9A705D2C011F7EC783355958CE03CC3F87 | 20060101|1741      |
|3    |E86879FF32808EC2FC68CB70379C2889748043EB | 20040211|1741      |
|3    |0B69826187B2F6ACF5B60DB1B0EC4F4B1013C20D | 20040520|1741      |
|8    |CDE47E6AC4AB0C98BAA4BD17D17B1BE6D55E894F | 20140703|1741      |
|1    |58E092642ECA3F9C89AC0D381591384A2B14A34F | 20140622|1740      |
|8    |05DC279074ED4AF2E42DCEE034BCA2FDEB928326 | 20150129|1741      |
|8    |71CA2DB3AD17753C889B7BAC7D4B8981B29B66BF | 20141220|1741      |
|NA   |NA                                       |       NA|NA        |


研究案例篩選 - 基於醫療紀錄
========================================================

提供診斷碼清單(向量)，並使用**%in%**或**grepl()**篩選符合此條件之所有資料


```r
library(dplyr)
# 174.* Malignant neoplasm of female breast
SelectedCase<-DiagSum %>% 
  filter(grepl("^174",診斷類別1))
knitr::kable(SelectedCase [1:10,c(1,3,12,26)])
```



|院區 |歸戶代號                                 | 住院日期|診斷類別1 |
|:----|:----------------------------------------|--------:|:---------|
|1    |57F193B5869DA564114CD08B6CE3F67882EAE617 | 20100124|1742      |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100122|1748      |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100326|1749      |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100226|1748      |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100423|1749      |
|3    |0BC0E21FAE4ADE290D434EA0C2DEC71F86A3C0E8 | 20100504|1742      |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100626|1749      |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100521|1749      |
|1    |59B5F0B18A4A1F6B89DBCF46AE1079D7EEA93E2A | 20100516|1744      |
|3    |5ED0C70C64E6CEE7BB8CC488909AE9A1432AD4EA | 20100708|1744      |

研究案例篩選 - 基於醫療紀錄
========================================================
type:alert

- 使用疾病分類統計檔DiagSum
- 篩選條件：**診斷類別1**欄位中，出現**174**開頭或**175**開頭的診斷碼
- 符合條件的患者共有幾人？

研究案例篩選 - 基於醫療紀錄
========================================================

若要搜尋多個欄位，可用以下方式:
- **filter_at**
- 寬表轉長表

```r
library(dplyr)
# 174.* Malignant neoplasm of female breast
SelectedCase<-DiagSum %>% 
  filter_at(vars(starts_with("診斷類別")), 
            any_vars(grepl("^174",.)))
knitr::kable(SelectedCase [1:10,c(1,3,12,26,27,28)])
```



|院區 |歸戶代號                                 | 住院日期|診斷類別1 |診斷類別2 |診斷類別3 |
|:----|:----------------------------------------|--------:|:---------|:---------|:---------|
|1    |B479DED3B05A6A39F32B49730ABAC8D36D63BE89 | 20100111|V581      |1748      |NA        |
|1    |57F193B5869DA564114CD08B6CE3F67882EAE617 | 20100124|1742      |4279      |NA        |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100122|1748      |NA        |NA        |
|3    |BC9343E012826E01ECE6B33D9C2B774F11EFC549 | 20091216|99859     |1749      |1970      |
|3    |49633CF7DEAAE3D677CF74464AD5F455EA981637 | 20100104|V581      |1748      |5990      |
|3    |BC9343E012826E01ECE6B33D9C2B774F11EFC549 | 20100209|99859     |1749      |1970      |
|1    |57F193B5869DA564114CD08B6CE3F67882EAE617 | 20100222|V581      |1742      |V0261     |
|1    |57F193B5869DA564114CD08B6CE3F67882EAE617 | 20100406|V581      |1742      |NA        |
|1    |57F193B5869DA564114CD08B6CE3F67882EAE617 | 20100315|V581      |1742      |NA        |
|3    |BC9343E012826E01ECE6B33D9C2B774F11EFC549 | 20100222|99859     |1749      |1970      |

研究案例篩選 - 基於醫療紀錄
========================================================

若要搜尋多個欄位，可用以下方式:
- **filter_at**
  - `filter_at(data,column,rules)`
- 寬表轉長表

```r
library(dplyr)
# 174.* Malignant neoplasm of female breast
SelectedCase<-DiagSum %>% 
  filter_at(vars(starts_with("診斷類別")), 
            any_vars(grepl("^174",.)))
knitr::kable(SelectedCase [1:10,c(1,3,12,26,27,28)])
```



|院區 |歸戶代號                                 | 住院日期|診斷類別1 |診斷類別2 |診斷類別3 |
|:----|:----------------------------------------|--------:|:---------|:---------|:---------|
|1    |B479DED3B05A6A39F32B49730ABAC8D36D63BE89 | 20100111|V581      |1748      |NA        |
|1    |57F193B5869DA564114CD08B6CE3F67882EAE617 | 20100124|1742      |4279      |NA        |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100122|1748      |NA        |NA        |
|3    |BC9343E012826E01ECE6B33D9C2B774F11EFC549 | 20091216|99859     |1749      |1970      |
|3    |49633CF7DEAAE3D677CF74464AD5F455EA981637 | 20100104|V581      |1748      |5990      |
|3    |BC9343E012826E01ECE6B33D9C2B774F11EFC549 | 20100209|99859     |1749      |1970      |
|1    |57F193B5869DA564114CD08B6CE3F67882EAE617 | 20100222|V581      |1742      |V0261     |
|1    |57F193B5869DA564114CD08B6CE3F67882EAE617 | 20100406|V581      |1742      |NA        |
|1    |57F193B5869DA564114CD08B6CE3F67882EAE617 | 20100315|V581      |1742      |NA        |
|3    |BC9343E012826E01ECE6B33D9C2B774F11EFC549 | 20100222|99859     |1749      |1970      |

研究案例篩選 - 基於醫療紀錄
========================================================

若要搜尋多個欄位，可用以下方式:
- filter_at
- **寬表轉長表**
  - `tidyr`套件中的`gather(data,原欄位名稱,數值名稱,轉長表欄位)`

```r
library(tidyr)
library(dplyr)
DiagSumLong<-DiagSum %>% 
  select(院區,歸戶代號,住院日期,starts_with("診斷類別")) %>%
  gather(診斷類別,診斷碼,starts_with("診斷類別"))
# 174.* Malignant neoplasm of female breast
SelectedCase<-DiagSumLong %>% 
  filter(grepl("^174",診斷碼))
knitr::kable(SelectedCase [1:10,])
```



|院區 |歸戶代號                                 | 住院日期|診斷類別  |診斷碼 |
|:----|:----------------------------------------|--------:|:---------|:------|
|1    |57F193B5869DA564114CD08B6CE3F67882EAE617 | 20100124|診斷類別1 |1742   |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100122|診斷類別1 |1748   |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100326|診斷類別1 |1749   |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100226|診斷類別1 |1748   |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100423|診斷類別1 |1749   |
|3    |0BC0E21FAE4ADE290D434EA0C2DEC71F86A3C0E8 | 20100504|診斷類別1 |1742   |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100626|診斷類別1 |1749   |
|1    |B2F80C7326546F8ADE1D5474119B70424F00FD5F | 20100521|診斷類別1 |1749   |
|1    |59B5F0B18A4A1F6B89DBCF46AE1079D7EEA93E2A | 20100516|診斷類別1 |1744   |
|3    |5ED0C70C64E6CEE7BB8CC488909AE9A1432AD4EA | 20100708|診斷類別1 |1744   |

研究案例篩選 - 基於醫療紀錄
========================================================
type:alert

- 使用疾病分類統計檔DiagSum
- 篩選條件：**診斷類別1~6**欄位中，出現**1740**或**1741**診斷碼
- 符合條件的患者共有幾人？
- 寬轉長？
- filter_at？

研究案例篩選 - 醫療紀錄+特定時間
========================================================

使用`lubridate`套件中的`ymd()`做日期轉換


















```
Error in as.POSIXlt.POSIXct(x, tz) : 
  (從警告轉換成) unknown timezone 'zone/tz/2018e.1.0/zoneinfo/Asia/Taipei'
```
